<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ­ AI è§’è‰²æ‰®æ¼”èŠå¤©å®¤</title>
  <link rel="stylesheet" href="/static/appstyle.css" />

  <!-- ğŸ” å¼•å…¥å…¨å±€è®¤è¯æ¨¡å— -->
  <script src="/static/AuthManager.js" defer></script>
</head>

<body onload="initChat()">
  <div class="container">
    <h1>ğŸ’¬ å’Œä½ çš„ AI å¯¹è¯</h1>

    <!-- å½“å‰è§’è‰²ä¿¡æ¯å±•ç¤º -->
    <div id="characterInfo" class="info-box">
      ğŸ§  æ­£åœ¨ä»¥æ‚¨è®¾å®šçš„è§’è‰²è¿›è¡Œå¯¹è¯...
    </div>

    <!-- èŠå¤©çª—å£ -->
    <div id="chatBox"></div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="input-area">
      <input 
        type="text" 
        id="userInput" 
        placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯..." 
        autofocus 
        onkeypress="if(event.key==='Enter') sendMessage()" 
      />
      <button onclick="sendMessage()">å‘é€</button>
    </div>

    <!-- æ§åˆ¶æŒ‰é’®åŒº -->
    <div style="margin-top: 20px; text-align: center;">
      <button onclick="clearChat()" style="background-color: #5bc0de; margin-right: 10px;">æ¸…ç©ºå¯¹è¯</button>
      <button onclick="AuthManager.logout()" style="background-color: #d9534f;">ç™»å‡º</button>
    </div>
  </div>

  <script>
    // é¡µé¢åˆå§‹åŒ–æ—¶æ£€æŸ¥è®¤è¯ï¼Œå¹¶å°è¯•æ¢å¤ä¸Šä¸‹æ–‡
    function initChat() {
      if (!window.AuthManager.isAuthenticated()) {
        alert("è¯·å…ˆç™»å½•ï¼");
        window.location.href = "/login";
        return;
      }

      // å¯é€‰ï¼šä»æœåŠ¡ç«¯è·å–å½“å‰ç”¨æˆ·è§’è‰²åç§°ï¼Œæ˜¾ç¤ºåœ¨ info åŒºåŸŸ
      loadCharacterInfo();
      
      // æ¬¢è¿è¯­
      appendMessage("system", "æ¬¢è¿å›æ¥ï¼ä½ å¯ä»¥å¼€å§‹èŠå¤©äº†ã€‚");
    }

    // è·å–ç”¨æˆ·è§’è‰²æè¿°ï¼ˆå¯é€‰å¢å¼ºä½“éªŒï¼‰
    async function loadCharacterInfo() {
      try {
        const res = await AuthManager.request("/user1/profile", { method: "GET" });
        const data = await res.json();
        const personality = data.personality || "æ— æ˜ç¡®æ€§æ ¼";
        const roleSetting = data.role_setting?.substring(0, 50) + "..." || "è‡ªå®šä¹‰è§’è‰²";

        document.getElementById("characterInfo").innerHTML = `
          <strong>å½“å‰è§’è‰²è®¾å®šï¼š</strong><br/>
          æ€§æ ¼ï¼š<em>${personality}</em><br/>
          æç¤ºè¯ï¼š<em>${roleSetting}</em>
        `;
      } catch (err) {
        console.warn("æ— æ³•åŠ è½½è§’è‰²ä¿¡æ¯", err);
      }
    }

    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
      const input = document.getElementById("userInput");
      const message = input.value.trim();

      if (!message) return;
      if (!window.AuthManager.isAuthenticated()) {
        alert("ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
        window.location.href = "/login";
        return;
      }

      // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
      appendMessage("user", message);
      input.value = "";

      try {
        const response = await AuthManager.request("/user1/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ message })
        });

        const data = await response.json();

        if (response.ok && data.reply) {
          appendMessage("ai", data.reply);
        } else {
          appendMessage("ai", `âŒ ${data.message || data.error || "AI è¿”å›é”™è¯¯"}`);
        }
      } catch (error) {
        console.error("å‘é€å¤±è´¥:", error);
        if (error.message.includes("æœªç™»å½•")) {
          alert("ç™»å½•å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•");
          window.location.href = "/login";
        } else {
          appendMessage("ai", "âš ï¸ ç½‘ç»œå¼‚å¸¸æˆ–æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚");
        }
      }
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©æ¡†
    function appendMessage(role, text) {
      const chatBox = document.getElementById("chatBox");
      const msgDiv = document.createElement("div");
      msgDiv.className = `message ${role}`;
      msgDiv.innerText = text;
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    }

    // æ¸…ç©ºèŠå¤©è®°å½•
    function clearChat() {
      if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ")) {
        document.getElementById("chatBox").innerHTML = "";
        appendMessage("system", "èŠå¤©è®°å½•å·²æ¸…ç©ºã€‚");
      }
    }
  </script>
</body>

</html>
